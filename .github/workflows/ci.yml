name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  MAIN_SCRIPT_PATH: "scripts/Invoke-vSphere8CISAudit.ps1"

jobs:
  powershell-analysis:
    name: PowerShell Script Analysis
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install PSScriptAnalyzer
      shell: powershell
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        
    - name: Run PSScriptAnalyzer
      shell: powershell
      run: |
        if (Test-Path "$env:MAIN_SCRIPT_PATH") {
          $results = Invoke-ScriptAnalyzer -Path "$env:MAIN_SCRIPT_PATH" -Severity Error
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Host "PSScriptAnalyzer found errors" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "PSScriptAnalyzer passed - no errors found" -ForegroundColor Green
          }
        } else {
          Write-Host "Script file not found, skipping analysis" -ForegroundColor Yellow
        }
        
  link-checker:
    name: Link Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: Install markdown-link-check
      run: npm install -g markdown-link-check@3.11.2
      
    - name: Check links in README
      run: |
        if [ -f README.md ]; then
          markdown-link-check README.md || true
        else
          echo "README.md not found, skipping link check"
        fi
      
  validate-structure:
    name: Repository Structure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate repository structure
      run: |
        echo "üîç Validating repository structure..."
        
        # Check for basic files
        if [[ -f "README.md" ]]; then
          echo "‚úÖ README.md exists"
        else
          echo "‚ö†Ô∏è README.md is missing"
        fi
        
        if [[ -d ".github/workflows" ]]; then
          echo "‚úÖ .github/workflows directory exists"
        else
          echo "‚ö†Ô∏è .github/workflows directory is missing"
        fi
        
        echo "üéâ Repository structure validation completed!"
        
  test-powershell-syntax:
    name: PowerShell Syntax Validation
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Test PowerShell syntax
      shell: powershell
      run: |
        Write-Host "Testing PowerShell script syntax..." -ForegroundColor Cyan
        
        if (Test-Path "$env:MAIN_SCRIPT_PATH") {
          try {
            $content = Get-Content "$env:MAIN_SCRIPT_PATH" -Raw -ErrorAction Stop
            $tokens = $null
            $errors = $null
            $null = [System.Management.Automation.PSParser]::Tokenize($content, [ref]$errors)
            
            if ($errors.Count -eq 0) {
              Write-Host "PowerShell syntax validation passed" -ForegroundColor Green
            } else {
              Write-Host "PowerShell syntax errors found:" -ForegroundColor Red
              $errors | ForEach-Object { Write-Host $_.Message -ForegroundColor Red }
              exit 1
            }
          }
          catch {
            Write-Host "PowerShell syntax validation failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "PowerShell script not found, skipping syntax check" -ForegroundColor Yellow
        }
        
  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate documentation
      run: |
        echo "üìö Generating documentation..."
        echo "‚úÖ Documentation generation completed"